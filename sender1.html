<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>WebSocket Chat</h1>

    <label for="user-id">Your User ID:</label>
    <input type="text" id="user-id" placeholder="Enter your User ID">
    <button onclick="loadUserList()">Load User List</button>

    <div id="user-list" style="display:none;">
        <!-- User list will be populated here -->
    </div>

    <div id="chat-box" style="display:none;">
        <!-- Chat messages will appear here -->
    </div>

    <input type="text" id="message" placeholder="Type your message" style="display:none;">
    <button id="send-button" onclick="sendMessage()" style="display:none;">Send</button>

    <script>
        let ws;
        let userId;
        let receiverId;

        async function loadUserList() {
            userId = document.getElementById('user-id').value;
            localStorage.setItem('userId', userId);

            const response = await axios.get('http://localhost/socket-testing/users.json');
            const users = response.data;

            const userListDiv = document.getElementById('user-list');
            userListDiv.style.display = 'block';
            
            users.forEach(user => {
                if (user._id !== userId) {
                    const userElement = document.createElement('div');
                    userElement.innerHTML = user.name;
                    userElement.onclick = () => setReceiver(user._id);
                    userListDiv.appendChild(userElement);
                }
            });
        }

        function setReceiver(id) {
            receiverId = id;
            connectWebSocket();
        }

        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:5678');
            ws.addEventListener('open', function(event) {
                document.getElementById('chat-box').style.display = 'block';
                document.getElementById('message').style.display = 'inline';
                document.getElementById('send-button').style.display = 'inline';
            });

            ws.addEventListener('message', function(event) {
                const data = JSON.parse(event.data);
                const chatBox = document.getElementById('chat-box');
                chatBox.innerHTML += `<p><strong>${data.sender_id}:</strong> ${data.text}</p>`;
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('message');
            const message = messageInput.value;

            const payload = {
                sender_id: userId,
                receiver_id: receiverId,
                text: message,
                chat_id: 'chat1'
            };

            ws.send(JSON.stringify(payload));
            messageInput.value = '';
        }

        // Initialize with stored userId if available
        const storedUserId = localStorage.getItem('userId');
        if (storedUserId) {
            document.getElementById('user-id').value = storedUserId;
            loadUserList();
        }
    </script>
</body>
</html>
